<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/mycss.css">
    <link rel="stylesheet" href="css/all.min.css">
    <link rel="stylesheet" href="js/animate.min.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="css/MarkerCluster.css">
    <style>
        .list-group {
            height: 85vh;
            overflow: scroll;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row vh-100">
            <div class="col-md-4 bg-warning">
                <select name="" id="cityOption" class="form-select-lg mb-3">
                    <option value="" selected disabled class="fw-900">----請先選縣市名稱----</option>
                    <option value="台北市">台北市</option>
                    <option value="台中市">台中市</option>
                </select>
                <select name="" id="areaOption" class="form-select-lg mb-3" disabled>
                    <option value="" selected disabled class="fw-900">----請先選鄉鎮區名稱----</option>
                    <option value="西屯區">西屯區</option>
                    <option value="南屯區">南屯區</option>
                </select>
                <ul class="list-group mt-3">
                    <li class="list-group-item">
                        <div class="h4 fw-900">藥局名稱</div>
                        <div class="h4 fw-900">地址:XXXX</div>
                        <div class="h4 fw-900">電話:xxxxx</div>
                        <div class="h4 fw-900">成人口罩:<span class="h1 text-danger fw-900">99</span>個</div>
                        <div class="h4 fw-900">兒童口罩:<span class="h1 text-danger fw-900">99</span>個</div>
                    </li>
                </ul>
            </div>
            <div class="col-md-8 bg-light">
                <div class="h-100 w-500" id="map"></div>
            </div>
        </div>
    </div>
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/jquery-3.7.1.js"></script>
    <script src="https://unpkg.com/counterup2@2.0.2/dist/index.js">	</script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="js/wow.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>AOS.init();</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>
    <script>
        new WOW().init();
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="js/leaflet.markercluster.js"></script>
    <script>
        AOS.init({
            duration: 900,
            easing: 'ease-out-quart',
            once: true
        });
    </script>

    <script>
        let map;
        let markerMap = {};
        let cityData = [];
        let selectedCity = [];
        let selectedArea = [];
        let maskData = [];


        $(async function () {
            //產生地圖
            initMap();
            //取得縣市資料
            cityData = await getCityData();
            console.log(cityData);
            //產生選單
            renderCityOption(cityData);

            //取得口罩資料
            maskData = await getMaskData();
            console.log(maskData);


            //監聽縣市選單
            $("#cityOption").on("change", function () {
                console.log(selectedCity);
                selectedCity = $(this).val();

                //打開鄉鎮區選單
                $("#areaOption").prop("disabled", false);
                //清空鄉鎮區選單
                $("#areaOption").empty();

                cityData.forEach((item) => {
                    if (item.CityName == selectedCity) {
                        //產生鄉鎮區選單
                        renderAreaOption(item.AreaList);
                    }
                });
            });
            //監聽鄉鎮區選單
            $("#areaOption").on("change", function () {
                console.log($(this).val());
                selectedArea = $(this).val();

                //過濾口罩藥局
                let filterMaskData = maskData.features.filter(item => {
                    return item.properties.county == selectedCity && item.properties.town == selectedArea;
                });
                console.log(filterMaskData);
                //產生藥局列表
                renderMaskList(filterMaskData);
                //清除所有marker
                removeMarkers();
                //產生masker列表
                renderMarkers(filterMaskData);


            });
            //監聽maskItem
            $(document).on("click", ".maskItem", function () {
                console.log($(this).data("key"));
                const key = $(this).data("key");
                console.log(markerMap[key]);
                console.log(markerMap[key].getLatLng());
                map.panTo(markerMap[key].getLatLng());
                markerMap[key].openPopup();
            });
        });
        //取得縣市資料
        function getCityData() {
            return $.ajax({
                type: "GET",
                url: "js/json/CityCountyData.json",
                dataType: "json",
                async: false
            });
        }
        //取得口罩藥局資料
        function getMaskData() {
            return $.ajax({
                type: "GET",
                url: "js/json/points.json",
                dataType: "json",
                async: false
            });
        }
        //產生口罩地圖
        function initMap() {
            map = L.map('map').setView([24.171425, 120.609670], 13);

            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            L.marker([24.171425, 120.609670]).addTo(map)
                .bindPopup('中分署')
                .openPopup();
        }
        //產生縣市選單
        function renderCityOption(data) {
            $("#cityOption").empty();
            $("#cityOption").append(`<option value=""selected disabled class="fw-900">----請先選縣市名稱----</option>`);
            data.forEach((item) => {
                let strHTML = `<option value="${item.CityName}">${item.CityName}</option>`;
                $("#cityOption").append(strHTML);
            });
        }
        //產生鄉鎮區選單
        function renderAreaOption(data) {
            $("#areaOption").empty();
            $("#areaOption").append(`<option value=""selected disabled class="fw-900">----選擇鄉鎮區名稱----</option>`);
            data.forEach((item) => {
                let strHTML = `<option value="${item.AreaName}">${item.AreaName}</option>`;
                $("#areaOption").append(strHTML);
            });
        }
        //產生藥局列表
        function renderMaskList(data) {
            $(".list-group").empty();
            //沒有藥局狀況
            if (data.length == 0) {
                $(".list-group").append(`<li class="list-group-item"> <div class="h4 fw-900 text-muted">該區沒有藥局</div></li>`);
                return;
            }
            //有藥局狀況
            data.forEach((item, key) => {
                let strHTML = `<li class="list-group-item maskItem" data-key="${key}">
                    <div class="h4 fw-900">${item.properties.name}</div>
                    <div class="h4 fw-900">${item.properties.address}</div>
                    <div class="h4 fw-900">${item.properties.phone}</div>
                    <div class="h4 fw-900">成人口罩:<span class="h1 text-danger fw-900">${item.properties.mask_adult}</span>個</div>
                    <div class="h4 fw-900">兒童口罩:<span class="h1 text-danger fw-900">${item.properties.mask_child}</span>個</div>
                    </li>`;
                $(".list-group").append(strHTML);
            });
        }
        //產生masker列表
        function renderMarkers(data) {
            if (data.length == 0) {
                return;
            }
            //清空索引表
            markerMap = {};
            data.forEach((item, key) => {
                const lat = item.geometry.coordinates[1];
                const lng = item.geometry.coordinates[0];
                if (key == 0) {
                    map.panTo([lat, lng]);
                }
                let popupHTML = `<div class="card">
                        <div class="card-body">
                            <div class="h4 fw-900">${item.properties.name}</div>
                            <div class="h4 fw-900">地址:${item.properties.address}</div>
                            <div class="h4 fw-900">電話:${item.properties.phone}</div>
                            <div class="h4 fw-900">成人口罩:<span class="h1 text-danger fw-900">${item.properties.mask_adult}</span>個</div>
                            <div class="h4 fw-900">兒童口罩:<span class="h1 text-danger fw-900">${item.properties.mask_child}</span>個</div>
                        </div>
                    </div>`;
                const marker = L.marker([lat, lng]).addTo(map).bindPopup(popupHTML);
                //產生索引表
                markerMap[key] = marker;
            });
        }
        //清除所有marker
        function removeMarkers() {
            map.eachLayer(function (layer) {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });
        }

    </script>


</body>

</html>